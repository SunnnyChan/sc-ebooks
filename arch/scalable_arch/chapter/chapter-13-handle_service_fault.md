# 处理服务故障

### 级联式服务故障
```md
通常，我们的服务依赖其它服务，也被其它服务所依赖。
如果其中一个服务发生故障，就可能导致我们的服务也出现故障，
而又导致消费者服务故障，这个错误是可以级联发生的。

当依赖服务发生故障时，如何挽救自己的服务？
```
### 如果响应服务故障
* 可预测的响应
```md
即使依赖的服务发生故障，你仍然需要为其生成一个可预测的响应。
例如：可能是一个错误提示。
只要你在API中包含了适当的错误处理机制，生成这种错误响应是完全可以接受的。

* 错误响应 和 不可预测响应
不可预测响应是指 预料之外的响应，而错误响应是有效的响应，表示无法处理特性的请求。
如：你的服务需要处理 “3+5”
正常的响应式“8”，这是一个可预测的响应。
如果你的服务准备执行操作 “5/0”，那么它应该返回“错误，无效请求”，这些都属于可预测的响应。
不可预测响应指某次返回 “500000000”，下次又返回“38393384384337”。
（有时候又被称为“无用的输入输出”）

即使你的依赖服务出现故障或发生不可预测行为，你也要尽可能不要把这种不可预测性传递给依赖于你的服务。
```
* 可理解的响应
```md
可理解，意味着你和上游服务之间对响应的格式和结构都表示同意。从而形成了一个约定。
即使你依赖的服务出现问题，你的响应也必须控制在约定的边界之内。

应该确保约定的接口能够覆盖所有意料之外的情况，包括依赖服务的故障。
```
* 合理的响应
```md
当服务出现问题，无法返回有效的响应时，它应该返回“无”或者“无法服务”这样的响应。
而不是其他的响应。
```
### 如何确定故障
> 如何确定一个依赖服务是否发生了故障？取决于故障模式 ：
```md
* 乱码响应
  是无法理解的响应，可能代表响应格式错误，或格式中存在语法错误。
* 表示致命错误发生的响应
  通常可能是服务本身发生了严重错误，还可能是发送给服务的请求无法理解而导致的。
* 结果超出预期范围
  返回的数据合理，并且格式正确，但数据没在预期之内。
* 结果可以理解但和所需的结果不匹配
* 没有收到响应
  捕获 永远无法到达的响应的更好方式：
  断路器模式，（熔断）
* 接受响应很慢
  一种检测慢依赖的更优雅的方式：
  创建多个“桶”来捕获最近调用依赖服务的性能。
  通过这个“桶”计算出一个出发断路器的规则。
```
### 适当的行为
> 当错误发生时，你该做什么呢？取决于错误的类型：
* 优雅降级
```md
* 场景：
如果你的服务再依赖服务故障时，仍然能执行有限的功能，那么就适合优雅降级。

* 什么是优雅降级
优雅降级是在当前服务缺少某个故障服务的结果时，可以通过降低工作量来尽可能的完成工作。

* 提供有限功能
对于一个服务来说，即使因为依赖服务故障不能提供所需服务，也应该当尽可能的提供服务价值。
```
* 优雅补偿
```md
即使你无法完全满足用户的需要，也要按照为用户提供价值的方向去改进，这就是优雅补偿。
```
* 尽早失败
```md
如果你已经确定无法挽救请求，那么应该尽快让请求失败。
这样做的结果，就是你会尽可能对请求进行完备的检查，尽可能提前确认请求的正确性，
当你继续发送请求时，应当要有很大的把握请求时可以成功的。

* 尽早失败 的原因
节约资源
响应性
  快速得把结果返回给上游，可以使请求方更快地做出其他决定。
错误复杂性
  有时候继续处理注定失败的请求，可能会造成更难诊断的错误。
```
* 用户导致的问题
```md
当你的服务可以接受来自用户的输入时，尽早失败变得更为重要。
如果你知道服务规定了哪些合理的限制条件，请尽早检查。

* 一个说明“尽早失败”重要性的案例
P78

* 提供服务约束
例如，如果你知道服务不能同时处理超过 5000 个账户，一定要在服务约束中声明这个限制条件，
进行测试，让所有超过该限制数量的请求都直接失败。
```